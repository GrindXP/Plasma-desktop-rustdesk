name: KDE Plasma Desktop with RustDesk & Android Studio

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  kde-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up /mnt storage
        run: |
          sudo mkdir -p /mnt/storage
          sudo chmod 777 /mnt/storage
          mkdir -p /mnt/storage/android-sdk
          mkdir -p /mnt/storage/android-avd
          df -h /mnt

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm 2>/dev/null || true

      - name: Install KDE Plasma Desktop
        run: |
          echo "Installing KDE Plasma Desktop ğŸ¨"
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            kde-plasma-desktop \
            plasma-nm \
            konsole \
            dolphin \
            kate \
            firefox \
            dbus-x11 \
            fonts-noto-color-emoji \
            wget curl net-tools htop \
            openjdk-17-jdk unzip cpu-checker \
            xvfb x11-xserver-utils \
            libfuse2
          echo "âœ… KDE Plasma installed"

      - name: Install Android SDK
        run: |
          echo "ğŸ“± Installing Android SDK..."
          cd /mnt/storage/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdtools.zip
          unzip -q cmdtools.zip && rm cmdtools.zip
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          echo "âœ… Android SDK installed"

      - name: Set Android Environment
        run: |
          echo "ANDROID_HOME=/mnt/storage/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/mnt/storage/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_AVD_HOME=/mnt/storage/android-avd" >> $GITHUB_ENV
          echo "/mnt/storage/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "/mnt/storage/android-sdk/platform-tools" >> $GITHUB_PATH

      - name: Install SDK Components
        run: |
          export ANDROID_HOME=/mnt/storage/android-sdk
          cd /mnt/storage/android-sdk
          yes | cmdline-tools/latest/bin/sdkmanager --licenses
          cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "emulator" \
            "system-images;android-34;google_apis;x86_64"
          echo "âœ… SDK components installed"

      - name: Download Android Studio
        run: |
          echo "ğŸ’¿ Downloading Android Studio..."
          cd /mnt/storage
          wget -q https://redirector.gvt1.com/edgedl/android/studio/ide-zips/2025.2.1.7/android-studio-2025.2.1.7-linux.tar.gz -O android-studio.tar.gz
          tar -xzf android-studio.tar.gz && rm android-studio.tar.gz
          echo "âœ… Android Studio extracted"

      - name: Download and Setup RustDesk AppImage
        run: |
          echo "ğŸ¦€ Downloading RustDesk AppImage..."
          cd /tmp
          
          # Download RustDesk AppImage
          wget -q https://github.com/rustdesk/rustdesk/releases/download/1.3.3/rustdesk-1.3.3-x86_64.AppImage -O rustdesk.AppImage
          
          chmod +x rustdesk.AppImage
          
          # Extract AppImage
          ./rustdesk.AppImage --appimage-extract
          
          # Move to /opt
          sudo mv squashfs-root /opt/rustdesk
          
          echo "âœ… RustDesk AppImage extracted to /opt/rustdesk"

      - name: Start Virtual Display
        run: |
          echo "ğŸ–¥ï¸ Starting virtual display..."
          Xvfb :0 -screen 0 1920x1080x24 &
          sleep 3
          echo "âœ… Virtual display started on :0"

      - name: Start KDE Plasma
        run: |
          export DISPLAY=:0
          export XDG_SESSION_TYPE=x11
          export XDG_SESSION_DESKTOP=KDE
          export XDG_CURRENT_DESKTOP=KDE
          
          # Start D-Bus
          eval $(dbus-launch --sh-syntax)
          
          # Start Plasma
          startplasma-x11 &
          sleep 5
          echo "âœ… KDE Plasma started"

      - name: Start RustDesk with Custom Server
        run: |
          export DISPLAY=:0
          
          echo "âš™ï¸ Starting RustDesk with custom server..."
          
          # Create config directory
          mkdir -p ~/.config/rustdesk
          
          # Write config file
          cat > ~/.config/rustdesk/RustDesk2.toml << 'EOFCONFIG'
          [options]
          custom-rendezvous-server = '159.195.6.61:21116'
          relay-server = '159.195.6.61:21117'
          api-server = ''
          key = 'kNZ9rGBAVPtperuSNtuKZN2ooRGQIYSjDbbx1dXIM5I='
          EOFCONFIG
          
          # Start RustDesk with custom server parameters
          /opt/rustdesk/usr/bin/rustdesk \
            --server 159.195.6.61:21116 \
            --password "${{ secrets.RUSTDESK_PASSWORD }}" &
          
          sleep 10
          
          # Get RustDesk ID
          RUSTDESK_ID=$(/opt/rustdesk/usr/bin/rustdesk --get-id 2>/dev/null || echo "Initializing...")
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ¦€ RUSTDESK + KDE PLASMA READY! ğŸ¦€                   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                       â•‘"
          echo "â•‘  ğŸ†” RustDesk ID: $RUSTDESK_ID"
          echo "â•‘  ğŸ”‘ Password: (from GitHub Secrets)                   â•‘"
          echo "â•‘  ğŸŒ Custom Server: 159.195.6.61                       â•‘"
          echo "â•‘  ğŸ–¥ï¸  Desktop: KDE Plasma on Xvfb                       â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  ğŸ“± Android Studio: /mnt/storage/android-studio       â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  ğŸ”Œ Android App Settings:                             â•‘"
          echo "â•‘     â€¢ ID Server: 159.195.6.61                         â•‘"
          echo "â•‘     â€¢ Relay Server: 159.195.6.61                      â•‘"
          echo "â•‘     â€¢ Key: kNZ9rGBAVPtperuSNtuKZN2ooRGQIYSjDbbx1dXIM5I= â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      - name: Keep Alive with Monitoring
        run: |
          echo "ğŸŸ¢ SESSION ACTIVE - Running for up to 6 hours"
          echo ""
          
          COUNT=0
          while true; do
            COUNT=$((COUNT + 1))
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Status Check #${COUNT} - $(date '+%H:%M:%S')"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Check RustDesk
            if pgrep -f "/opt/rustdesk.*rustdesk" > /dev/null; then
              echo "âœ… RustDesk: Running"
              RUSTDESK_ID=$(/opt/rustdesk/usr/bin/rustdesk --get-id 2>/dev/null || echo "Unknown")
              echo "ğŸ†” Current ID: $RUSTDESK_ID"
            else
              echo "âš ï¸  RustDesk: Restarting..."
              export DISPLAY=:0
              /opt/rustdesk/usr/bin/rustdesk \
                --server 159.195.6.61:21116 \
                --password "${{ secrets.RUSTDESK_PASSWORD }}" &
              sleep 3
            fi
            
            # Check Xvfb
            if pgrep -f "Xvfb.*:0" > /dev/null; then
              echo "âœ… Display Server: Running (Xvfb)"
            else
              echo "âš ï¸  Display: Restarting..."
              Xvfb :0 -screen 0 1920x1080x24 &
              sleep 2
            fi
            
            # Check KDE
            if pgrep -f "plasmashell" > /dev/null; then
              echo "âœ… KDE Plasma: Running"
            fi
            
            # Check Android Studio
            if pgrep -f "android-studio" > /dev/null; then
              echo "ğŸ“± Android Studio: Running"
            fi
            
            # System resources
            echo "ğŸ’¾ Root: $(df -h / | tail -1 | awk '{print $5 " used"}')"
            echo "ğŸ’¾ /mnt: $(df -h /mnt | tail -1 | awk '{print $5 " used (" $4 " free)"}')"
            echo "ğŸ§  Memory: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            sleep 180  # Check every 3 minutes
          done
