name: KDE Plasma Desktop with RustDesk

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  kde-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up /mnt storage
        run: |
          sudo mkdir -p /mnt/storage
          sudo chmod 777 /mnt/storage
          mkdir -p /mnt/storage/android-sdk
          mkdir -p /mnt/storage/android-avd
          df -h /mnt

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
          sudo chmod 666 /dev/kvm 2>/dev/null || true

      - name: Install KDE Plasma Desktop
        run: |
          echo "Installing KDE Plasma Desktop ğŸ¨"
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            kde-plasma-desktop \
            plasma-nm \
            konsole \
            dolphin \
            kate \
            firefox \
            dbus-x11 \
            fonts-noto-color-emoji \
            wget curl net-tools htop \
            openjdk-17-jdk unzip cpu-checker \
            xvfb x11-xserver-utils
          echo "âœ… KDE Plasma installed"

      - name: Install Android SDK
        run: |
          echo "ğŸ“± Installing Android SDK..."
          cd /mnt/storage/android-sdk
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdtools.zip
          unzip -q cmdtools.zip && rm cmdtools.zip
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
          echo "âœ… Android SDK installed"

      - name: Set Android Environment
        run: |
          echo "ANDROID_HOME=/mnt/storage/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=/mnt/storage/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_AVD_HOME=/mnt/storage/android-avd" >> $GITHUB_ENV
          echo "/mnt/storage/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "/mnt/storage/android-sdk/platform-tools" >> $GITHUB_PATH

      - name: Install SDK Components
        run: |
          export ANDROID_HOME=/mnt/storage/android-sdk
          cd /mnt/storage/android-sdk
          yes | cmdline-tools/latest/bin/sdkmanager --licenses
          cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "emulator" \
            "system-images;android-34;google_apis;x86_64"
          echo "âœ… SDK components installed"

      - name: Install RustDesk
        run: |
          echo "ğŸ¦€ Installing RustDesk..."
          wget -q https://github.com/rustdesk/rustdesk/releases/download/1.3.3/rustdesk-1.3.3-x86_64.deb -O rustdesk.deb
          sudo apt install -y ./rustdesk.deb
          rm rustdesk.deb
          
          # Stop systemd service
          sudo systemctl stop rustdesk 2>/dev/null || true
          sudo systemctl disable rustdesk 2>/dev/null || true
          
          echo "âœ… RustDesk installed"

      - name: Start Virtual Display
        run: |
          echo "ğŸ–¥ï¸ Starting virtual display..."
          Xvfb :0 -screen 0 1920x1080x24 &
          sleep 3
          echo "âœ… Virtual display started on :0"

      - name: Start KDE Plasma
        run: |
          export DISPLAY=:0
          export XDG_SESSION_TYPE=x11
          export XDG_SESSION_DESKTOP=KDE
          export XDG_CURRENT_DESKTOP=KDE
          
          eval $(dbus-launch --sh-syntax)
          startplasma-x11 &
          sleep 5
          echo "âœ… KDE Plasma started"

      - name: Configure and Start RustDesk
        env:
          RUSTDESK_KEY: ${{ secrets.RUSTDESK_KEY }}
        run: |
          export DISPLAY=:0
          
          echo "âš™ï¸ Configuring RustDesk (passwordless auto-accept mode)..."
          
          # Verify key secret exists
          if [ -z "$RUSTDESK_KEY" ]; then
            echo "âŒ ERROR: RUSTDESK_KEY secret not found!"
            exit 1
          fi
          
          # Create config directory
          mkdir -p ~/.config/rustdesk
          
          # Create config with auto-accept (no password needed)
          cat > ~/.config/rustdesk/RustDesk2.toml << EOF
          [options]
          custom-rendezvous-server = "159.195.6.61"
          relay-server = "159.195.6.61"
          api-server = ""
          key = "$RUSTDESK_KEY"
          
          [access_mode]
          accept-connections = "always"
          EOF
          
          echo "âœ… Config created - passwordless auto-accept enabled"
          
          # Start RustDesk
          rustdesk &
          
          sleep 10
          
          # Get ID
          RUSTDESK_ID=$(rustdesk --get-id 2>/dev/null || echo "Initializing...")
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ¦€ RUSTDESK + KDE PLASMA READY! ğŸ¦€                   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                       â•‘"
          echo "â•‘  ğŸ†” RustDesk ID: $RUSTDESK_ID"
          echo "â•‘  ğŸ”“ Password: NONE (Auto-Accept Enabled)              â•‘"
          echo "â•‘  ğŸŒ Server: 159.195.6.61                              â•‘"
          echo "â•‘  ğŸ–¥ï¸  Desktop: KDE Plasma (Xvfb)                        â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  ğŸ“± Android SDK: /mnt/storage/android-sdk             â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  âš¡ CONNECTION INSTRUCTIONS:                          â•‘"
          echo "â•‘     1. Enter ID: $RUSTDESK_ID"
          echo "â•‘     2. Tap Connect button                             â•‘"
          echo "â•‘     3. NO password needed - auto connects!            â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘  ğŸ”Œ Android App Settings:                             â•‘"
          echo "â•‘     â€¢ ID Server: 159.195.6.61                         â•‘"
          echo "â•‘     â€¢ Relay Server: 159.195.6.61                      â•‘"
          echo "â•‘     â€¢ Key: (from RUSTDESK_KEY secret)                 â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

      - name: Keep Alive with Monitoring
        run: |
          echo "ğŸŸ¢ SESSION ACTIVE - Running for up to 6 hours"
          echo ""
          
          COUNT=0
          while true; do
            COUNT=$((COUNT + 1))
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Status Check #${COUNT} - $(date '+%H:%M:%S')"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Check RustDesk
            if pgrep rustdesk > /dev/null; then
              echo "âœ… RustDesk: Running"
              RUSTDESK_ID=$(rustdesk --get-id 2>/dev/null || echo "Unknown")
              echo "ğŸ†” Current ID: $RUSTDESK_ID"
            else
              echo "âš ï¸  RustDesk: Restarting..."
              export DISPLAY=:0
              rustdesk &
              sleep 3
            fi
            
            # Check Xvfb
            if pgrep -f "Xvfb.*:0" > /dev/null; then
              echo "âœ… Display Server: Running (Xvfb)"
            else
              echo "âš ï¸  Display: Restarting..."
              Xvfb :0 -screen 0 1920x1080x24 &
              sleep 2
            fi
            
            # Check KDE
            if pgrep plasmashell > /dev/null; then
              echo "âœ… KDE Plasma: Running"
            fi
            
            # System resources
            echo "ğŸ’¾ Root: $(df -h / | tail -1 | awk '{print $5 " used"}')"
            echo "ğŸ’¾ /mnt: $(df -h /mnt | tail -1 | awk '{print $5 " used (" $4 " free)"}')"
            echo "ğŸ§  Memory: $(free -h | grep Mem | awk '{print $3 "/" $2}')"
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            
            sleep 180
          done
